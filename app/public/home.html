<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Friends-Finder Homepage</title>

  <!-- Latest compiled and minified CSS & JS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" media="screen" href="assets/styles/main.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

</head>

<body>
  <style>
    /* body styling */
      body {
        background: url("https://media0.giphy.com/media/26ufcYAkp8e66vanu/giphy.gif?cid=3640f6095c196e07436d654a2eebe3f9");
        background-size: fit-content; 
    }
    /* jumbotron styling */
    .jumbotron {
      background: pink;
      opacity: .9;
    }
    h1 {
      color: blue;
    }
    
    /* headers styling */
    h2:first-child{
      background: midnightblue;
      color: lightblue;
    }
    h2 {
      color: blue;
    }
    h2:last-child {
      border-bottom: 10px solid red;
    }
    /* card styling */
    .card {
      background: gray;
      opacity: 0.9;
    }
    .card-header {
      background: rgb(0, 142, 185);
      color: white;
    }
    label{
      font-size: 48px;
    }
    /* button styling */
    .submit{
      width: 100px;
      margin: auto;
    }
  </style>

  <div class="container">

    <!-- Header -->
    <div class="jumbotron text-center">
      <h1><span> <i class="fa fa-gratipay"></i></span> Have you found a friend? <i class="fa fa-gratipay"></i></span></h1>
      <hr>
      <h2>Your Current Matches!</h2>
      <br>

      <div>
        <a href="/survey"><button class="btn btn-lg btn-primary"><span class="fa fa-heart"></span> Take the Fiendship
            survey! <span class="fa fa-heart"></span></button></a>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <!-- Current Matches card -->
        <div class="card mb-5">
          <div class="card-header">
            <h4>Your Profile</h4>
          </div>
          <div class="card-body text-center">
            <ul id="userInfo" class="list-group"><label class="text-center" for="user-name">Enter Your Name</label>
              <input type="text" class="form-control text-center" id="user-name" required>
              <button type="submit" class="btn btn-primary submit">Submit</button></ul>
          </div>
        </div>
        <!-- Current Matches card -->
        <div class="card">
          <div class="card-header">
            <h4>Current Matches</h4>
          </div>
          <div class="card-body">
            <ul id="friendList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>


    <footer class="footer mt-5 text-center">
      <div class="container">
        <p>Control Panel</p>
        <p><a href="#" id="clear">Clear User</a> | <a href="/api/friends">API Table Link</a> </p>
      </div>
    </footer>

  </div>

</body>


<!-- BELOW CODE IS CRITICAL. IT HANDLES HOW FORM DATA IS LOADED FROM OUR SERVER -->
<script type="text/javascript">

  // initialize user name string and chosen boolean
  var userName;
  var chosen;
  // create a submit function that captures the user name and removes the input field so it cannot be used again unless refreshed and also empties the friendsList so the query can be run again without repeat results
  $(".submit").click(function () {
    userName = $("#user-name").val().trim();
    chosen = true
    $("#friendList").empty();
    $("#userInfo").empty();
    runFriendsQuery();
  });



  // function fro the ajax method to populate the fields.
  function runFriendsQuery() {
    // The AJAX function uses the URL of our API to GET the data associated with it (initially set to localhost)
    $.ajax({ url: "/api/friends", method: "GET" })
      .then(function (friendData) {

        // Here we then log the friendData to console, where it will show up as an object.
        console.log(friendData);
        console.log("------------------------------------");

        // Loop through and display each of the customers
        for (var i = 0; i < friendData.length; i++) {

          // Get a reference to the friendsList element and populate it with friends or the user if friendName = UserName
          var friendsList = $("#friendList");
          var userNameCard = $("#userInfo");

          // setup a userArray for compatability score checks
          if (userName === friendData[i].friendName) {
            var userArray = friendData[i].answerArray
          }
          console.log(userArray)

          // set up a compatability score
          var compatabilityScore;
          if (chosen) {
            // loop through bouth arrays and add one for every answer that is the same
            for (var j = 0; j < friendData[i].answerArray; j++) {
              if (friendData[i].answerArray === userArray[j]) {
                compatabilityScore++;
              }
              compatabilityScore = ((compatabilityScore / 12) * 100) + "%"
            }

          }
          console.log(compatabilityScore)

          // Then display the fields in the HTML
          var listItem = $("<li class='card list-group-item mt-4 mb-5'>");

          // compatability score logic
          if (compatabilityScore != null) {
            listItem.append(
              $("<h2>").text("Friends Name: " + friendData[i].friendName),
              $("<hr>"),
              $("<h2>").text("age: " + friendData[i].friendAge),
              $("<h2>").text("gender: " + friendData[i].friendGender),

              $("<h2>").text("Compatability score: " + compatabilityScore)
            );
          }
          else {
            listItem.append(
              $("<h2>").text("Friends Name: " + friendData[i].friendName),
              $("<hr>"),
              $("<h2>").text("age: " + friendData[i].friendAge),
              $("<h2>").text("gender: " + friendData[i].friendGender),

              $("<h2>").text("Take the quiz to check your compatability with others.")
            );
          }
          if (friendData[i].friendName === userName) {
            userNameCard.append(listItem);
          }
          else {
            friendsList.append(listItem);
          }
        }
      });
  }



  // This function resets all of the data in our tables. This is intended to let you restart a demo.
  function clearUser() {
    alert("Clearing...");

    // Clear the current user from the server and then empty the User element on the client
    $.ajax({ url: "/api/clear", method: "POST" }).then(function () {
      $("#UserInfo").empty();
    });
  }

  $("#clear").on("click", clearUser);


  // Run Queries!
  // ==========================================
  runFriendsQuery();


</script>

</html>